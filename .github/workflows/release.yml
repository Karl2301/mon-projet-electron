name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  release:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]
        
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Create assets directory and placeholder icon
        run: |
          mkdir -p ./assets
          # CrÃ©er une icÃ´ne temporaire pour les tests (1x1 pixel transparent)
          echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==" | base64 -d > ./assets/icon.png
          cp ./assets/icon.png ./assets/icon.ico
        shell: bash
        
      - name: Build CSS production
        run: npm run build-css:prod
        
      - name: Create oauth.config.json
        run: |
          if [ ! -f "./src/oauth.config.json" ]; then
            echo '{"clientId":"${{ secrets.OAUTH_CLIENT_ID || 'demo-client-id' }}","tenant":"common","scopes":"offline_access Mail.Read Mail.ReadWrite"}' > ./src/oauth.config.json
          fi
        shell: bash
        
      - name: Build and package for macOS
        if: matrix.os == 'macos-latest'
        run: |
          npm run package
          npm run make
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          
      - name: Build and package for Windows
        if: matrix.os == 'windows-latest'
        run: |
          npm run package
          npm run make
        env:
          CSC_LINK: ${{ secrets.WINDOWS_CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.WINDOWS_CSC_KEY_PASSWORD }}
          
      - name: Build and package for Linux
        if: matrix.os == 'ubuntu-latest'
        run: |
          npm run package
          npm run make
          
      - name: List and prepare build artifacts
        id: artifacts
        run: |
          echo "Listing build artifacts:"
          find ./out -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.deb" -o -name "*.rpm" -o -name "*.zip" -o -name "*.AppImage" \)
          
          # CrÃ©er un dossier pour les artefacts finaux
          mkdir -p ./release-artifacts
          
          # Copier tous les artefacts avec des noms standardisÃ©s
          if [ "${{ matrix.os }}" = "macos-latest" ]; then
            find ./out -name "*.dmg" -exec cp {} ./release-artifacts/ \;
            find ./out -name "*.zip" -exec cp {} ./release-artifacts/ \;
          elif [ "${{ matrix.os }}" = "windows-latest" ]; then
            find ./out -name "*.exe" -exec cp {} ./release-artifacts/ \;
            find ./out -name "*.zip" -exec cp {} ./release-artifacts/ \;
          elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            find ./out -name "*.deb" -exec cp {} ./release-artifacts/ \;
            find ./out -name "*.rpm" -exec cp {} ./release-artifacts/ \;
            find ./out -name "*.AppImage" -exec cp {} ./release-artifacts/ \;
            find ./out -name "*.zip" -exec cp {} ./release-artifacts/ \;
          fi
          
          echo "Final artifacts:"
          ls -la ./release-artifacts/
        shell: bash
        
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-artifacts
          path: ./release-artifacts/*
          retention-days: 5
          
  create-release:
    needs: release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          
      - name: Prepare release files
        run: |
          echo "Downloaded artifacts structure:"
          find ./artifacts -type f
          
          # CrÃ©er un dossier pour tous les fichiers de release
          mkdir -p ./release-files
          
          # Copier tous les artefacts dans un seul dossier
          find ./artifacts -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.deb" -o -name "*.rpm" -o -name "*.zip" -o -name "*.AppImage" \) -exec cp {} ./release-files/ \;
          
          echo "Release files:"
          ls -la ./release-files/
          
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
          
      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ðŸš€ Release ${{ steps.version.outputs.VERSION }}
          
          ### ðŸ“§ Mon Projet Electron - Gestionnaire d'emails Outlook
          
          Cette release inclut les packages pour toutes les plateformes supportÃ©es :
          
          - **macOS** : Fichier `.dmg` pour installation sur Mac
          - **Windows** : Fichier `.exe` pour installation sur Windows  
          - **Linux** : Fichiers `.deb` (Ubuntu/Debian), `.rpm` (CentOS/Fedora) et `.AppImage` (portable)
          
          ### âœ¨ FonctionnalitÃ©s principales
          - Synchronisation avec Outlook via Microsoft Graph API
          - Sauvegarde intelligente des emails dans des sous-dossiers INBOX
          - Gestion automatique des dossiers clients
          - Interface moderne et intuitive
          - Mode hors ligne avec cache
          
          ### ðŸ“¥ Installation
          1. TÃ©lÃ©chargez le fichier correspondant Ã  votre systÃ¨me d'exploitation
          2. ExÃ©cutez l'installateur
          3. Suivez les instructions Ã  l'Ã©cran
          
          ### ðŸ”§ Configuration requise
          - Compte Microsoft Outlook/Office 365
          - Connexion Internet pour la synchronisation
          - Permissions d'Ã©criture sur le systÃ¨me de fichiers
          
          ---
          
          **Note :** Cette application nÃ©cessite une configuration OAuth. Contactez l'administrateur pour obtenir les clÃ©s d'API si nÃ©cessaire.
          EOF
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: 'Mon Projet Electron ${{ steps.version.outputs.VERSION }}'
          body_path: ./release_notes.md
          draft: false
          prerelease: false
          files: ./release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
